<?php

namespace BRS\FileBundle\Repository;

use BRS\FileBundle\Entity\File;
use BRS\CoreBundle\Core\Utility;
use Gedmo\Tree\Entity\Repository\NestedTreeRepository;
use Symfony\Component\HttpFoundation\Request;

/**
 * FileRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FileRepository extends NestedTreeRepository
{
		
	public function getRootByName($name, $create = FALSE)
	{
		$files = $this->getEntityManager()
			->createQuery("SELECT f FROM BRSFileBundle:File f WHERE f.name = :name AND f.tree_level = 0")
			->setParameter('name', $name)
			->setMaxResults(1)
			->getResult();
		
		if(isset($files[0]) && $files[0] !== null)
			$file = $files[0];
		
		else {
			$file = new File();
			$file->setName($name);
			$file->setIsDir(true);
			
			$em = $this->getEntityManager();
			$em->persist($file);
			$em->flush();
		}
		
		return $file;
	}
	
	public function searchInDir($dir, $query, $order = null)
	{
		
		$query_builder = $this->getEntityManager()
			->createQueryBuilder()
			->select('f')
			->from('BRSFileBundle:File', 'f')
			->where('f.tree_left > :tree_left AND f.tree_right < :tree_right')
			->setParameter('tree_left', $dir->tree_left)
			->setParameter('tree_right', $dir->tree_right);
		
		if($order){
			
			$query_builder->orderBy('f.' . $order);
		}
			
		
		$query_pieces = explode(' ', $query);
			
		foreach($query_pieces as $i => $q){
			
			$query_builder->andWhere('f.name LIKE :name' . $i)->setParameter('name'. $i, '%' . $q . '%');
		}
			
		$files = $query_builder->getQuery()->getResult();
		
		return $files;
	}
	
	
	public function hanldeUploadRequest(\Symfony\Component\HttpFoundation\Request $request, $form){
		
		if ($request->getMethod() === 'POST') {
			
			
			
			
			//strip everything but the csrf token from the request and just handle the file
			
			$form_post = $request->get('form');
			
			$parent_folder = $request->get('parent_folder');
			
			$params = array('form' => array('_token' => $form_post['_token']));
			
			$new_request = Request::create($request->getUri(), 'POST', $params, $_COOKIE, $_FILES, $_SERVER, $request->getContent());
			
			
			$form->bindRequest($new_request);
			
			if ($form->isValid()) {
				
				$file = $form->getData();
				
				$em = $this->getEntityManager();
				
				$parent_id = null;
				
				if(isset($form_post['parent_id'])){
				
					$parent_id = $form_post['parent_id'];
				}
				
				if($parent_folder){
						
					$parent = $this->getRootByName($parent_folder);			
					
					$parent_id = $parent->id;
				}
				
				if($parent_id){
					
					$parent = $em->getReference('\BRS\FileBundle\Entity\File', $parent_id);
				
					$file->setParent($parent);
				}
				
				
				$em->persist($file);
				
				$em->flush();
	
				$values = array(
					'status' => 'success',
					'file' => $file,
				);
				
				return $values;
				
			}else{
				
				$errors = Utility::get_form_errors($form);
				
				$values = array(
					'status' => 'fail',
					'errors' => $errors,
				);
				
				return $values;
			}
		}
		
		$values = array(
			'status' => 'fail',
		);
		
		return $values;
	}
}
